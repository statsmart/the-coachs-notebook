import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  FileText, Image as ImageIcon, Video, File, Star, X,
  Upload, Send, Loader2
} from 'lucide-react';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";

const entryTypes = [
  { type: 'note', icon: FileText, label: 'Note', color: 'bg-slate-100 text-slate-700' },
  { type: 'image', icon: ImageIcon, label: 'Image', color: 'bg-blue-100 text-blue-700' },
  { type: 'video', icon: Video, label: 'Video', color: 'bg-purple-100 text-purple-700' },
  { type: 'file', icon: File, label: 'File', color: 'bg-orange-100 text-orange-700' },
  { type: 'milestone', icon: Star, label: 'Milestone', color: 'bg-amber-100 text-amber-700' },
];

export default function NewEntryForm({ 
  relationshipId, 
  user, 
  profile, 
  onSuccess, 
  onCancel 
}) {
  const [entryType, setEntryType] = useState('note');
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [tagInput, setTagInput] = useState('');
  const [tags, setTags] = useState([]);
  const [file, setFile] = useState(null);
  const [filePreview, setFilePreview] = useState(null);
  const [uploading, setUploading] = useState(false);
  const [submitting, setSubmitting] = useState(false);

  const handleFileChange = (e) => {
    const selectedFile = e.target.files[0];
    if (!selectedFile) return;

    setFile(selectedFile);

    // Create preview for images
    if (selectedFile.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => setFilePreview(e.target.result);
      reader.readAsDataURL(selectedFile);
    } else if (selectedFile.type.startsWith('video/')) {
      setFilePreview(URL.createObjectURL(selectedFile));
    } else {
      setFilePreview(null);
    }
  };

  const handleAddTag = (e) => {
    if (e.key === 'Enter' && tagInput.trim()) {
      e.preventDefault();
      if (!tags.includes(tagInput.trim().toLowerCase())) {
        setTags([...tags, tagInput.trim().toLowerCase()]);
      }
      setTagInput('');
    }
  };

  const removeTag = (tagToRemove) => {
    setTags(tags.filter(t => t !== tagToRemove));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!content.trim() && !file) return;

    setSubmitting(true);
    let mediaUrl = null;
    let mediaName = null;

    try {
      // Upload file if present
      if (file) {
        setUploading(true);
        const result = await base44.integrations.Core.UploadFile({ file });
        mediaUrl = result.file_url;
        mediaName = file.name;
        setUploading(false);
      }

      // Create entry
      await base44.entities.TimelineEntry.create({
        relationship_id: relationshipId,
        author_id: user.id,
        author_name: user.full_name,
        author_role: profile.role,
        author_avatar: profile.avatar_url,
        entry_type: entryType,
        title: title.trim() || null,
        content: content.trim(),
        media_url: mediaUrl,
        media_name: mediaName,
        tags: tags.length > 0 ? tags : null,
        is_pinned: false,
        is_private: false
      });

      onSuccess();
    } catch (error) {
      console.error('Failed to create entry:', error);
    } finally {
      setSubmitting(false);
    }
  };

  const needsFile = ['image', 'video', 'file'].includes(entryType);

  return (
    <motion.div
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      className="bg-white rounded-2xl shadow-lg border p-6"
    >
      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Entry Type Selection */}
        <div>
          <Label className="text-sm text-slate-500 mb-3 block">Entry Type</Label>
          <div className="flex flex-wrap gap-2">
            {entryTypes.map(({ type, icon: Icon, label, color }) => (
              <button
                key={type}
                type="button"
                onClick={() => setEntryType(type)}
                className={cn(
                  "flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all",
                  entryType === type
                    ? `${color} ring-2 ring-offset-2 ring-emerald-500`
                    : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                )}
              >
                <Icon className="w-4 h-4" />
                {label}
              </button>
            ))}
          </div>
        </div>

        {/* Title (optional) */}
        <div>
          <Label htmlFor="title">Title (optional)</Label>
          <Input
            id="title"
            placeholder="Give this entry a title..."
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            className="mt-1"
          />
        </div>

        {/* Content */}
        <div>
          <Label htmlFor="content">
            {entryType === 'note' ? 'Note' : 'Description'}
          </Label>
          <Textarea
            id="content"
            placeholder={
              entryType === 'milestone' 
                ? "Describe this achievement..."
                : entryType === 'note'
                ? "Write your note here..."
                : "Add a description..."
            }
            value={content}
            onChange={(e) => setContent(e.target.value)}
            rows={4}
            className="mt-1"
          />
        </div>

        {/* File Upload */}
        {needsFile && (
          <div>
            <Label>
              {entryType === 'image' ? 'Upload Image' : entryType === 'video' ? 'Upload Video' : 'Upload File'}
            </Label>
            <div className="mt-1">
              {!file ? (
                <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:border-emerald-400 hover:bg-emerald-50/50 transition-colors">
                  <input
                    type="file"
                    accept={
                      entryType === 'image' ? 'image/*' : 
                      entryType === 'video' ? 'video/*' : 
                      '*/*'
                    }
                    onChange={handleFileChange}
                    className="hidden"
                  />
                  <Upload className="w-8 h-8 text-slate-400 mb-2" />
                  <span className="text-sm text-slate-500">
                    Click to upload or drag and drop
                  </span>
                </label>
              ) : (
                <div className="relative">
                  {entryType === 'image' && filePreview && (
                    <img
                      src={filePreview}
                      alt="Preview"
                      className="w-full h-48 object-cover rounded-xl"
                    />
                  )}
                  {entryType === 'video' && filePreview && (
                    <video
                      src={filePreview}
                      className="w-full h-48 object-cover rounded-xl"
                      controls
                    />
                  )}
                  {entryType === 'file' && (
                    <div className="flex items-center gap-3 p-4 bg-slate-50 rounded-xl">
                      <File className="w-8 h-8 text-slate-400" />
                      <span className="font-medium text-slate-700 truncate">{file.name}</span>
                    </div>
                  )}
                  <button
                    type="button"
                    onClick={() => {
                      setFile(null);
                      setFilePreview(null);
                    }}
                    className="absolute top-2 right-2 w-8 h-8 bg-white/80 backdrop-blur rounded-full flex items-center justify-center hover:bg-white"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Tags */}
        <div>
          <Label htmlFor="tags">Tags</Label>
          <div className="mt-1 space-y-2">
            <Input
              id="tags"
              placeholder="Add tags (press Enter)"
              value={tagInput}
              onChange={(e) => setTagInput(e.target.value)}
              onKeyDown={handleAddTag}
            />
            {tags.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {tags.map((tag) => (
                  <Badge 
                    key={tag} 
                    variant="secondary"
                    className="cursor-pointer hover:bg-red-100 hover:text-red-600"
                    onClick={() => removeTag(tag)}
                  >
                    #{tag} <X className="w-3 h-3 ml-1" />
                  </Badge>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Actions */}
        <div className="flex justify-end gap-3 pt-4 border-t">
          <Button type="button" variant="outline" onClick={onCancel}>
            Cancel
          </Button>
          <Button 
            type="submit"
            disabled={submitting || (!content.trim() && !file)}
            className="bg-emerald-600 hover:bg-emerald-700"
          >
            {submitting ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                {uploading ? 'Uploading...' : 'Posting...'}
              </>
            ) : (
              <>
                <Send className="w-4 h-4 mr-2" />
                Post Entry
              </>
            )}
          </Button>
        </div>
      </form>
    </motion.div>
  );
}